<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Trị - Đá Mỹ Nghệ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/common.css">
</head>
<body class="bg-gray-50">

<!-- Navbar -->
<nav class="bg-gradient-to-r from-blue-600 to-blue-800 p-4 text-white shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <a href="index.html" class="text-2xl font-bold flex items-center">
            <i class="fas fa-gem mr-2"></i>
            Đá Mỹ Nghệ - Admin
        </a>
        <div class="flex space-x-6">
            <a href="index.html" class="hover:text-blue-200 transition-colors">
                <i class="fas fa-home mr-1"></i>Trang Chủ
            </a>
            <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                <i class="fas fa-sign-out-alt mr-1"></i>Đăng Xuất
            </button>
        </div>
    </div>
</nav>

<!-- Admin Dashboard -->
<div class="container mx-auto my-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Upload Section -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">
                    <i class="fas fa-upload mr-2"></i>Thêm Sản Phẩm Mới
                </h2>

    <!-- Upload Image -->
    <div class="mb-6">
                    <label class="block text-lg font-medium text-gray-700 mb-2">
                        <i class="fas fa-image mr-2"></i>Hình Ảnh Sản Phẩm
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer" id="upload-area">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Nhấp để tải hình ảnh lên</p>
                        <p class="text-sm text-gray-500 mt-2">Hỗ trợ: JPG, PNG, GIF (Tối đa 10MB)</p>
                    </div>
                    <div id="upload-preview" class="mt-4 hidden">
                        <img id="preview-image" class="w-full h-48 object-cover rounded-lg" alt="Preview">
                        <button onclick="removeUpload()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors">
                            <i class="fas fa-trash mr-1"></i>Xóa Hình Ảnh
                        </button>
                    </div>
    </div>

                <!-- Product Details -->
    <div class="mb-6">
                    <label for="product-name" class="block text-lg font-medium text-gray-700 mb-2">
                        <i class="fas fa-tag mr-2"></i>Tên Sản Phẩm
                    </label>
                    <input type="text" id="product-name" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nhập tên sản phẩm">
    </div>

    <div class="mb-6">
                    <label for="description" class="block text-lg font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-2"></i>Mô Tả Sản Phẩm
                    </label>
                    <textarea id="description" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="4" placeholder="Nhập mô tả chi tiết về sản phẩm"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="category" class="block text-lg font-medium text-gray-700 mb-2">
                            <i class="fas fa-tags mr-2"></i>Danh Mục
                        </label>
                        <select id="category" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Chọn danh mục</option>
            <option value="Lân">Lân</option>
            <option value="Bình hoa">Bình hoa</option>
            <option value="Dĩa">Dĩa</option>
            <option value="Lư">Lư</option>
                            <option value="Lư hương rồng">Lư hương rồng</option>
                            <option value="Sư tử">Sư tử</option>
                            <option value="Ống hương">Ống hương</option>
                            <option value="Hủ cốt">Hủ cốt</option>
                        </select>
                    </div>
                    <div>
                        <label for="size" class="block text-lg font-medium text-gray-700 mb-2">
                            <i class="fas fa-ruler mr-2"></i>Kích Thước
                        </label>
                        <select id="size" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Chọn kích thước</option>
                            <option value="20cm">20cm</option>
                            <option value="25cm">25cm</option>
                            <option value="30cm">30cm</option>
                            <option value="40cm">40cm</option>
                        </select>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="color" class="block text-lg font-medium text-gray-700 mb-2">
                        <i class="fas fa-palette mr-2"></i>Màu Sắc
                    </label>
                    <select id="color" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Chọn màu sắc</option>
                        <option value="Đen">Đen</option>
                        <option value="Trắng">Trắng</option>
                        <option value="Vàng">Vàng</option>
                        <option value="Ấn Độ">Ấn Độ</option>
        </select>
    </div>

                <button id="save-btn" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-save mr-2"></i>Lưu Sản Phẩm
                </button>
            </div>
        </div>

        <!-- Products Management -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">
                        <i class="fas fa-list mr-2"></i>Quản Lý Sản Phẩm
                    </h2>
                    <div class="flex space-x-2">
                        <button onclick="refreshProducts()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                            <i class="fas fa-sync-alt mr-1"></i>Làm Mới
                        </button>
                        <button onclick="exportProducts()" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700 transition-colors">
                            <i class="fas fa-download mr-1"></i>Xuất Dữ Liệu
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="mb-6">
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <input type="text" id="search-products" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tìm kiếm sản phẩm...">
                        </div>
                        <select id="filter-category" class="p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Tất cả danh mục</option>
                            <option value="Lân">Lân</option>
                            <option value="Bình hoa">Bình hoa</option>
                            <option value="Dĩa">Dĩa</option>
                            <option value="Lư">Lư</option>
                            <option value="Lư hương rồng">Lư hương rồng</option>
                            <option value="Sư tử">Sư tử</option>
                            <option value="Ống hương">Ống hương</option>
                            <option value="Hủ cốt">Hủ cốt</option>
                        </select>
                    </div>
                </div>

                <!-- Products List -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Hình Ảnh</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tên Sản Phẩm</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Danh Mục</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kích Thước</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Màu Sắc</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loading-products" class="text-center py-8 hidden">
                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Đang tải sản phẩm...</p>
                </div>

                <!-- No Products State -->
                <div id="no-products" class="text-center py-12 hidden">
                    <i class="fas fa-box-open text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Chưa có sản phẩm nào</h3>
                    <p class="text-gray-500">Hãy thêm sản phẩm đầu tiên bằng cách tải hình ảnh lên</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800">Chỉnh Sửa Sản Phẩm</h3>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="edit-form">
                    <!-- Edit form will be populated here -->
                </div>
                
                <div class="flex justify-end space-x-4 mt-6">
                    <button onclick="closeEditModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors">
                        Hủy
                    </button>
                    <button onclick="saveEdit()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Lưu Thay Đổi
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Cloudinary Configuration
    const cloudName = 'meaning17';
    let currentProductId = null;
    let uploadedImageUrl = null;

    // Initialize Cloudinary Upload Widget
    const cloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: cloudName,
        uploadPreset: 'ml_default', // Sử dụng preset mặc định
        multiple: false,
        sources: ['local', 'url', 'camera'],
        showAdvancedOptions: false,
        cropping: false,
        maxFileSize: 10000000, // 10MB
        resourceType: 'image',
        folder: 'damynghe', // Tạo folder riêng cho dự án
        tags: ['damynghe', 'product'],
        context: {
            alt: 'Product Image',
            caption: 'Đá Mỹ Nghệ Product'
        }
    }, (error, result) => {
        if (error) {
            console.error('Upload error:', error);
            alert('Có lỗi xảy ra khi tải hình ảnh lên. Vui lòng thử lại.');
            return;
        }

        if (result.event === 'success') {
            uploadedImageUrl = result.info.secure_url;
            document.getElementById('preview-image').src = uploadedImageUrl;
            document.getElementById('upload-preview').classList.remove('hidden');
            document.getElementById('upload-area').classList.add('hidden');
            
            // Thêm thông tin vào context của Cloudinary
            cloudinaryWidget.updateConfig({
                context: {
                    alt: document.getElementById('product-name').value || 'Product Image',
                    caption: document.getElementById('description').value || 'Đá Mỹ Nghệ Product'
                }
            });
        }
    });

    // Event Listeners
    document.getElementById('upload-area').addEventListener('click', () => {
        cloudinaryWidget.open();
    });

    document.getElementById('save-btn').addEventListener('click', saveProduct);
    document.getElementById('search-products').addEventListener('input', filterProducts);
    document.getElementById('filter-category').addEventListener('change', filterProducts);

    // Functions
    function saveProduct() {
        const name = document.getElementById('product-name').value.trim();
        const description = document.getElementById('description').value.trim();
        const category = document.getElementById('category').value;
        const size = document.getElementById('size').value;
        const color = document.getElementById('color').value;

        if (!uploadedImageUrl) {
            alert('Vui lòng tải hình ảnh lên trước!');
            return;
        }

        if (!name || !description || !category || !size || !color) {
            alert('Vui lòng điền đầy đủ thông tin sản phẩm!');
            return;
        }

        const product = {
            id: Date.now(),
            name: name,
            description: description,
            category: category,
            size: size,
            color: color,
            imageUrl: uploadedImageUrl,
            createdAt: new Date().toISOString()
        };

        // Lưu vào localStorage
        let products = JSON.parse(localStorage.getItem('products')) || [];
        products.push(product);
        localStorage.setItem('products', JSON.stringify(products));

        // Reset form
        resetForm();
        
        // Refresh products list
        loadProducts();
        
        alert('Sản phẩm đã được lưu thành công!');
    }

    function resetForm() {
        document.getElementById('product-name').value = '';
        document.getElementById('description').value = '';
        document.getElementById('category').value = '';
        document.getElementById('size').value = '';
        document.getElementById('color').value = '';
        uploadedImageUrl = null;
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-area').classList.remove('hidden');
    }

    function removeUpload() {
        uploadedImageUrl = null;
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-area').classList.remove('hidden');
    }

    function loadProducts() {
        const loading = document.getElementById('loading-products');
        const noProducts = document.getElementById('no-products');
        const tableBody = document.getElementById('products-table-body');

        loading.classList.remove('hidden');
        tableBody.innerHTML = '';

        setTimeout(() => {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            loading.classList.add('hidden');

            if (products.length === 0) {
                noProducts.classList.remove('hidden');
                return;
            }

            noProducts.classList.add('hidden');
            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3">
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md">
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">${product.name}</div>
                        <div class="text-sm text-gray-500 line-clamp-2">${product.description}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${product.category}</span>
                    </td>
                    <td class="px-4 py-3 text-gray-700">${product.size}</td>
                    <td class="px-4 py-3 text-gray-700">${product.color}</td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editProduct(${product.id})" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                <i class="fas fa-edit mr-1"></i>Sửa
                            </button>
                            <button onclick="deleteProduct(${product.id})" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 transition-colors text-sm">
                                <i class="fas fa-trash mr-1"></i>Xóa
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }, 500);
    }

    function filterProducts() {
        const searchTerm = document.getElementById('search-products').value.toLowerCase();
        const filterCategory = document.getElementById('filter-category').value;
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const tableBody = document.getElementById('products-table-body');

        const filteredProducts = products.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                product.description.toLowerCase().includes(searchTerm);
            const matchesCategory = !filterCategory || product.category === filterCategory;
            return matchesSearch && matchesCategory;
        });

        tableBody.innerHTML = '';
        filteredProducts.forEach(product => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
                <td class="px-4 py-3">
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md">
                </td>
                <td class="px-4 py-3">
                    <div class="font-medium text-gray-900">${product.name}</div>
                    <div class="text-sm text-gray-500 line-clamp-2">${product.description}</div>
                </td>
                <td class="px-4 py-3">
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">${product.category}</span>
                </td>
                <td class="px-4 py-3 text-gray-700">${product.size}</td>
                <td class="px-4 py-3 text-gray-700">${product.color}</td>
                <td class="px-4 py-3">
                    <div class="flex space-x-2">
                        <button onclick="editProduct(${product.id})" class="bg-blue-600 text-white px-3 py-1 rounded-md hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-edit mr-1"></i>Sửa
                        </button>
                        <button onclick="deleteProduct(${product.id})" class="bg-red-600 text-white px-3 py-1 rounded-md hover:bg-red-700 transition-colors text-sm">
                            <i class="fas fa-trash mr-1"></i>Xóa
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function editProduct(productId) {
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const product = products.find(p => p.id === productId);
        
        if (!product) {
            alert('Không tìm thấy sản phẩm!');
            return;
        }

        currentProductId = productId;
        const editForm = document.getElementById('edit-form');
        editForm.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover rounded-lg">
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên Sản Phẩm</label>
                        <input type="text" id="edit-name" value="${product.name}" class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mô Tả</label>
                        <textarea id="edit-description" rows="3" class="w-full p-2 border border-gray-300 rounded-md">${product.description}</textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Danh Mục</label>
                            <select id="edit-category" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="Lân" ${product.category === 'Lân' ? 'selected' : ''}>Lân</option>
                                <option value="Bình hoa" ${product.category === 'Bình hoa' ? 'selected' : ''}>Bình hoa</option>
                                <option value="Dĩa" ${product.category === 'Dĩa' ? 'selected' : ''}>Dĩa</option>
                                <option value="Lư" ${product.category === 'Lư' ? 'selected' : ''}>Lư</option>
                                <option value="Lư hương rồng" ${product.category === 'Lư hương rồng' ? 'selected' : ''}>Lư hương rồng</option>
                                <option value="Sư tử" ${product.category === 'Sư tử' ? 'selected' : ''}>Sư tử</option>
                                <option value="Ống hương" ${product.category === 'Ống hương' ? 'selected' : ''}>Ống hương</option>
                                <option value="Hủ cốt" ${product.category === 'Hủ cốt' ? 'selected' : ''}>Hủ cốt</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Kích Thước</label>
                            <select id="edit-size" class="w-full p-2 border border-gray-300 rounded-md">
                                <option value="20cm" ${product.size === '20cm' ? 'selected' : ''}>20cm</option>
                                <option value="25cm" ${product.size === '25cm' ? 'selected' : ''}>25cm</option>
                                <option value="30cm" ${product.size === '30cm' ? 'selected' : ''}>30cm</option>
                                <option value="40cm" ${product.size === '40cm' ? 'selected' : ''}>40cm</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Màu Sắc</label>
                        <select id="edit-color" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="Đen" ${product.color === 'Đen' ? 'selected' : ''}>Đen</option>
                            <option value="Trắng" ${product.color === 'Trắng' ? 'selected' : ''}>Trắng</option>
                            <option value="Vàng" ${product.color === 'Vàng' ? 'selected' : ''}>Vàng</option>
                            <option value="Ấn Độ" ${product.color === 'Ấn Độ' ? 'selected' : ''}>Ấn Độ</option>
                        </select>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('edit-modal').classList.remove('hidden');
    }

    function saveEdit() {
        const name = document.getElementById('edit-name').value.trim();
        const description = document.getElementById('edit-description').value.trim();
        const category = document.getElementById('edit-category').value;
        const size = document.getElementById('edit-size').value;
        const color = document.getElementById('edit-color').value;

        if (!name || !description || !category || !size || !color) {
            alert('Vui lòng điền đầy đủ thông tin!');
            return;
        }

        let products = JSON.parse(localStorage.getItem('products')) || [];
        const productIndex = products.findIndex(p => p.id === currentProductId);
        
        if (productIndex !== -1) {
            products[productIndex] = {
                ...products[productIndex],
                name: name,
                description: description,
                category: category,
                size: size,
                color: color,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('products', JSON.stringify(products));
            closeEditModal();
            loadProducts();
            alert('Sản phẩm đã được cập nhật thành công!');
        }
    }

    function closeEditModal() {
        document.getElementById('edit-modal').classList.add('hidden');
        currentProductId = null;
    }

    function deleteProduct(productId) {
        if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')) {
            let products = JSON.parse(localStorage.getItem('products')) || [];
            products = products.filter(p => p.id !== productId);
            localStorage.setItem('products', JSON.stringify(products));
            loadProducts();
            alert('Sản phẩm đã được xóa thành công!');
        }
    }

    function refreshProducts() {
        loadProducts();
    }

    function exportProducts() {
        const products = JSON.parse(localStorage.getItem('products')) || [];
        const dataStr = JSON.stringify(products, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'damynghe-products.json';
        link.click();
        URL.revokeObjectURL(url);
    }

    function logout() {
        if (confirm('Bạn có chắc chắn muốn đăng xuất?')) {
            localStorage.removeItem('adminLoggedIn');
            window.location.href = 'login.html';
        }
    }
</script>

    <!-- JavaScript Files -->
    <script src="js/common.js"></script>
    <script src="js/data.js"></script>
    <script src="js/admin.js"></script>
</body>
</html> 